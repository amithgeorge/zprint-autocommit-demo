name: Format clojure source using zprint
on:
  pull_request:
    branches:
      - '*'

jobs:
  format-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Prepare java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Install clojure tools
        uses: DeLaGuardo/setup-clojure@10.2
        with:
          cli: 'latest'
          lein: 2.9.1
          bb: 'latest'
          clj-kondo: 'latest'
          zprint: 1.2.5
      - name: Cache clojure dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
          # List all files containing dependencies:
          key: cljdeps-${{ hashFiles('deps.edn', 'project.clj', 'bb.edn') }}
          restore-keys: cljdeps-
      - name: Get Clojure version
        run: clojure --version
      - name: Get zprint version
        run: zprint --version
      - id: changed_files
        name: Get all added and modified files
        uses: masesgroup/retrieve-changed-files@v2
      - name: Print all changed files
        run: |
          echo "all files" ${{ steps.changed_files.outputs.all }};
          echo "added files" ${{ steps.changed_files.outputs.added }};
          echo "modified files" ${{ steps.changed_files.outputs.modified }};
          echo "added and modified files" ${{ steps.changed_files.outputs.added_modified }};
          echo "renamed files" ${{ steps.changed_files.outputs.renamed }};
      - name: Format the code
        run: |
          dir="`pwd`"
          echo ${{ steps.changed_files.outputs.added_modified }} | grep -i -E '.*\.edn$|.*\.clj[sc]?$' -type f | xargs --verbose zprint --url-only "file://${dir}/.zprint.edn" --formatted-summary-write
          echo ${{ steps.changed_files.outputs.renamed }} | grep -i -E '.*\.edn$|.*\.clj[sc]?$' -type f | xargs --verbose zprint --url-only "file://${dir}/.zprint.edn" --formatted-summary-write
      # - name: Commit changes
      #   uses: EndBug/add-and-commit@v9
      #   with:
      #     default_author: github_actions
